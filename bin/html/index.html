<!DOCTYPE html>
<html>
  <head>
    <title>ChatGPT API Example</title>
    <meta charset="utf-8" />
    <!-- vue3 and naive-ui -->
    <script src="https://npm.elemecdn.com/vue@3/dist/vue.global.js"></script>
    <script src="https://npm.elemecdn.com/naive-ui@2.34.3/dist/index.prod.js"></script>
    <script type="module" src="https://npm.elemecdn.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule="" src="https://npm.elemecdn.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <script src="https://npm.elemecdn.com/localforage@1.10.0/dist/localforage.min.js"></script>
    <style scoped>
      /* layout */
      html,
      body,
      #chat {
        width: 100%;
        height: 100%;
      }

      .n-layout-header,
      .n-layout-footer {
        background-color: #18222d;
        color: #fff;
      }

      .n-layout-sider {
        background-color: #18222d;
        color: #fff;
      }
      .n-layout--static-positioned {
        background-color: #22303f;
        color: #fff;
      }

      /* input */

      .n-input-word-count {
        bottom: 0 !important;
        font-size: 0.1em !important;
      }

      .send-icon {
        cursor: pointer;
        color: #2080f0 !important;
      }

      /* timeline */

      .n-timeline {
        text-align: left;
        width: 600px;
        left: calc((100% + 120px) / 2 - 320px);
        background-color: #18222d;
        padding: 20px;
      }

      .n-timeline-item {
        --n-title-text-color: #9caec7 !important;
        --n-content-text-color: #d1d5d9 !important;
        --n-meta-text-color: #738292 !important;
      }
      .n-timeline-item:last-child {
        --n-content-text-color: #a9bcd6 !important;
      }
      .n-timeline-item-content {
        white-space: break-spaces;
      }
      /* n-notification */
      .n-message-container {
        top: 40% !important;
        left: 0 !important;
        right: 0 !important;
        /* right: 25px !important; */
      }
    </style>
  </head>

  <body>
    <div id="chat" style="text-align: center">
      <div style="position: relative; height: 100%">
        <n-layout position="absolute" style="height: 100%">
          <!--  -->
          <n-layout-header
            style="height: 64px; padding: 10px; display: flex; align-items: center; justify-content: center"
          >
            <n-h2 style="margin: 0"
              ><n-gradient-text
                :gradient="{
              from: '#ffffff',
              to: '#a9bcd6'
            }"
              >
                {{ title }}
              </n-gradient-text></n-h2
            >
          </n-layout-header>
          <n-layout has-sider sider-placement="right" position="absolute" style="top: 64px; bottom: 80px">
            <!--  -->
            <n-layout-content ref="contentRef" content-style="padding: 24px;" :native-scrollbar="false">
              <n-timeline ref="timeline" :icon-size="20">
                <template v-for="item in timelineItems">
                  <n-timeline-item :color="item.color" :content="item.content" :time="item.time">
                    <template #icon v-if="item.type == 'user'"> <icon-svg-user /></template>
                    <template #icon v-if="item.type == 'bot'"> <icon-svg-bot /></template>
                  </n-timeline-item>
                </template>
              </n-timeline>
            </n-layout-content>
            <!--  -->
            <n-layout-sider
              collapse-mode="width"
              :collapsed-width="120"
              :width="240"
              :native-scrollbar="false"
              :default-collapsed="true"
              show-trigger="bar"
              content-style="padding: 24px;"
            >
            </n-layout-sider>
          </n-layout>
          <!--  -->
          <n-layout-footer position="absolute" style="height: 80px; padding: 10px">
            <n-input
              v-model:value="comment"
              clearable
              autofocus
              placeholder="..."
              size="large"
              style="
                height: 100%;
                width: 900px;
                text-align: left;
                --n-scrollbar-bezier: cubic-bezier(0.4, 0, 0.2, 1);
                --n-scrollbar-color: rgba(0, 0, 0, 0.25);
                --n-scrollbar-color-hover: rgba(0, 0, 0, 0.4);
                --n-scrollbar-border-radius: 5px;
                --n-scrollbar-width: 5px;
                --n-scrollbar-height: 5px;
              "
              v-on:keyup.enter.native="send"
              :input-props="{ autocomplete: 'nope' }"
              :autosize="{
                minRows: 3,
                maxRows: 3
              }"
            >
              <template #suffix>
                <n-icon v-if="start" size="25" @click="send" class="send-icon">
                  <svg-send />
                </n-icon>
                <n-icon v-if="!start" size="25" class="send-load-icon">
                  <svg-send-lock />
                </n-icon>
              </template>
            </n-input>
          </n-layout-footer>
        </n-layout>
      </div>
    </div>
    <script type="module">
      import { fetchEventSource } from "https://unpkg.com/@microsoft/fetch-event-source@2.0.1/lib/esm/index.js";
      const { message, notification } = naive.createDiscreteApi(["message", "notification"], {
        configProviderProps: Vue.computed(() => ({
          theme: naive.lightTheme,
        })),
      });

      const app = Vue.createApp({
        setup() {
          const contentRef = Vue.ref(null);
          const contentScrollToBottom = () => {
            contentRef.value.scrollTo({
              top: contentRef.value.$el.querySelector(".n-scrollbar-content").offsetHeight,
              behavior: "smooth",
            });
          };
          const timelineItems = Vue.reactive([]);
          const comment = Vue.ref("");
          let start = Vue.ref(true);

          localforage.getItem("timelineItems", function (err, value) {
            if (value != null) {
              timelineItems.push(...value);
            } else {
              timelineItems.push({
                type: "bot",
                color: "#2080f0",
                content: "唉呀，咩事捏？偶系BingChat-Sydney",
                time: formattedDate(),
              });
            }
            Vue.nextTick(() => {
              contentScrollToBottom();
            });
          });

          function formattedDate() {
            const currentDate = new Date();
            const year = currentDate.getFullYear();
            const month = String(currentDate.getMonth() + 1).padStart(2, "0");
            const day = String(currentDate.getDate()).padStart(2, "0");
            const hours = String(currentDate.getHours()).padStart(2, "0");
            const minutes = String(currentDate.getMinutes()).padStart(2, "0");
            const seconds = String(currentDate.getSeconds()).padStart(2, "0");
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
          }

          function send() {
            if (!start.value) {
              return;
            }
            if (!comment.value) {
              message.warning("侬嘞啥都米讲呀", {
                keepAliveOnHover: true,
              });
              return;
            }
            timelineItems[timelineItems.length - 1].color = "grey";
            timelineItems.push({ type: "user", color: "grey", content: comment.value, time: formattedDate() });

            localforage.getItem("conversation", function (err, conversation) {
              let toggle;
              try {
                const body = {
                  jailbreakConversationId: conversation == null ? true : conversation.jailbreakConversationId,
                };

                if (conversation != null) {
                  if (body.jailbreakConversationId) {
                    body["jailbreakConversationId"] = conversation.jailbreakConversationId;
                    body["parentMessageId"] = conversation.messageId;
                  } else {
                    // TODO
                  }
                }

                const opts = {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    message: comment.value,
                    stream: true,
                    clientOptions: { clientToUse: "bing" },
                    ...body,
                  }),
                };
                console.log(opts);
                let reply = "";
                const controller = new AbortController();
                if (start.value) {
                  start.value = false;
                  timelineItems.push({ type: "bot", color: "#18a058", content: "", time: formattedDate() });
                  toggle = self.setInterval(() => {
                    timelineItems[timelineItems.length - 1].color =
                      timelineItems[timelineItems.length - 1].color == "#18a058" ? "grey" : "#18a058";
                  }, 500);
                  contentScrollToBottom();
                }
                comment.value = "";
                fetchEventSource("/conversation", {
                  ...opts,
                  signal: controller.signal,
                  onopen(response) {
                    if (response.status === 200) {
                      return;
                    }
                    start.value = true;
                    window.clearInterval(toggle);
                    timelineItems[timelineItems.length - 1] = {
                      type: "bot",
                      color: "#d03050",
                      content: `Failed to send message. HTTP ${response.status} - ${response.statusText}`,
                      time: formattedDate(),
                    };
                    throw new Error(`Failed to send message. HTTP ${response.status} - ${response.statusText}`);
                  },
                  onclose() {
                    start.value = true;
                    window.clearInterval(toggle);
                    timelineItems[timelineItems.length - 1] = {
                      type: "bot",
                      color: "#d03050",
                      content: "Failed to send message. Server closed the connection unexpectedly.",
                      time: formattedDate(),
                    };
                    throw new Error("Failed to send message. Server closed the connection unexpectedly.");
                  },
                  onerror(err) {
                    throw err;
                  },
                  onmessage(message) {
                    // { data: 'Hello', event: '', id: '', retry: undefined }
                    if (message.data === "[DONE]") {
                      start.value = true;
                      controller.abort();
                      window.clearInterval(toggle);
                      timelineItems[timelineItems.length - 1].color = "#2080f0";
                      timelineItems[timelineItems.length - 1].time = formattedDate();
                      localforage.setItem("timelineItems", Vue.toRaw(timelineItems));
                      return;
                    }
                    if (message.event === "result") {
                      localforage.setItem("conversation", JSON.parse(message.data));
                      return;
                    }
                    timelineItems[timelineItems.length - 1].content += JSON.parse(message.data);
                    reply += JSON.parse(message.data);
                    contentScrollToBottom();
                  },
                });
                return reply;
              } catch (err) {
                console.log("ERROR", err);
                start.value = true;
                window.clearInterval(toggle);
                timelineItems.push({ type: "bot", color: "#d03050", content: `${err}`, time: formattedDate() });
              }
            });
            // TODO
            // const arr = ["你", "好", "我", "是", "bot"];
            // let start = true;
            // arr.forEach((element) => {
            //   if (start) {
            //     start = false;
            //     timelineItems.push({ type: "bot", color: "#2080f0", content: element, time: formattedDate() });
            //   } else {
            //     timelineItems[timelineItems.length - 1].content += element;
            //   }
            // });
          }

          return {
            title: "Chat API Example",
            timelineItems,
            comment,
            start,
            contentRef,
            send,
            noSideSpace: (value) => !value.startsWith(" ") && !value.endsWith(" "),
          };
        },
        methods: {},
      });

      app
        .component("icon-svg-user", {
          template: `<n-icon><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 1024 1024"><path d="M858.5 763.6a374 374 0 0 0-80.6-119.5a375.63 375.63 0 0 0-119.5-80.6c-.4-.2-.8-.3-1.2-.5C719.5 518 760 444.7 760 362c0-137-111-248-248-248S264 225 264 362c0 82.7 40.5 156 102.8 201.1c-.4.2-.8.3-1.2.5c-44.8 18.9-85 46-119.5 80.6a375.63 375.63 0 0 0-80.6 119.5A371.7 371.7 0 0 0 136 901.8a8 8 0 0 0 8 8.2h60c4.4 0 7.9-3.5 8-7.8c2-77.2 33-149.5 87.8-204.3c56.7-56.7 132-87.9 212.2-87.9s155.5 31.2 212.2 87.9C779 752.7 810 825 812 902.2c.1 4.4 3.6 7.8 8 7.8h60a8 8 0 0 0 8-8.2c-1-47.8-10.9-94.3-29.5-138.2zM512 534c-45.9 0-89.1-17.9-121.6-50.4S340 407.9 340 362c0-45.9 17.9-89.1 50.4-121.6S466.1 190 512 190s89.1 17.9 121.6 50.4S684 316.1 684 362c0 45.9-17.9 89.1-50.4 121.6S557.9 534 512 534z" fill="currentColor"></path></svg></n-icon>`,
        })
        .component("icon-svg-bot", {
          template: `<n-icon><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 32 32"><path d="M18 10h2v2h-2z" fill="currentColor"></path><path d="M12 10h2v2h-2z" fill="currentColor"></path><path d="M26 20h-5v-2h1a2.002 2.002 0 0 0 2-2v-4h2v-2h-2V8a2.002 2.002 0 0 0-2-2h-2V2h-2v4h-4V2h-2v4h-2a2.002 2.002 0 0 0-2 2v2H6v2h2v4a2.002 2.002 0 0 0 2 2h1v2H6a2.002 2.002 0 0 0-2 2v8h2v-8h20v8h2v-8a2.002 2.002 0 0 0-2-2zM10 8h12v8H10zm3 10h6v2h-6z" fill="currentColor"></path></svg></n-icon>`,
        })
        .component("svg-send", {
          template: `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24"><g fill="none"><path d="M12.815 12.197l-7.532 1.255a.5.5 0 0 0-.386.318L2.3 20.728c-.248.64.421 1.25 1.035.942l18-9a.75.75 0 0 0 0-1.341l-18-9c-.614-.307-1.283.303-1.035.942l2.598 6.958a.5.5 0 0 0 .386.318l7.532 1.255a.2.2 0 0 1 0 .395z" fill="currentColor"></path></g></svg>`,
        })
        .component("svg-send-lock", {
          template: `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 20 20"><g fill="none"><path d="M2.721 1.051l15.355 7.566a.5.5 0 0 1 0 .897l-.657.324a5.5 5.5 0 0 0-8.394 4.136L2.72 17.08a.5.5 0 0 1-.704-.576l1.521-5.745a.5.5 0 0 1 .401-.365l6.881-1.147a.25.25 0 0 0 .188-.146l.018-.06a.25.25 0 0 0-.15-.272l-.056-.016L3.9 7.6a.5.5 0 0 1-.4-.365L2.016 1.628a.5.5 0 0 1 .704-.577zM19 14.5a4.5 4.5 0 1 1-9 0a4.5 4.5 0 0 1 9 0zM14.5 12a.5.5 0 0 0-.5.5v2a.5.5 0 0 0 .5.5H16a.5.5 0 0 0 0-1h-1v-1.5a.5.5 0 0 0-.5-.5z" fill="currentColor"></path></g></svg>`,
        });

      app.use(naive);
      app.mount("#chat");
    </script>
  </body>
</html>
